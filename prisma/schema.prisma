// Prisma schema for Burn Rate Calendar
// PostgreSQL database for Railway deployment

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  passwordSalt String   @map("password_salt")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // 2FA fields
  totpSecret    String?  @map("totp_secret")   // Encrypted TOTP secret
  totpEnabled   Boolean  @default(false) @map("totp_enabled")
  backupCodes   String?  @map("backup_codes")  // Encrypted JSON array of backup codes

  // Password reset fields
  resetToken       String?   @unique @map("reset_token")
  resetTokenExpiry DateTime? @map("reset_token_expiry")

  // Email verification fields
  emailVerified       Boolean   @default(false) @map("email_verified")
  verificationToken   String?   @unique @map("verification_token")
  verificationExpiry  DateTime? @map("verification_expiry")

  settings             UserSetting[]
  transactions         UserTransaction[]
  excludedTransactions UserExcludedTransaction[]
  includedTransactions UserIncludedTransaction[]
  dailyBudgets         UserDailyBudget[]

  @@map("users")
}

model UserSetting {
  userId String @map("user_id")
  key    String
  value  String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, key])
  @@map("user_settings")
}

model UserTransaction {
  id            String  @id
  odataId       String? @map("odata_id") // Original transaction ID from Monobank
  userId        String  @map("user_id")
  accountId     String? @map("account_id") // Monobank account ID for multi-account filtering
  time          Int
  description   String
  mcc           Int
  amount        Int
  balance       Int
  cashbackAmount Int     @default(0) @map("cashback_amount")
  currencyCode  Int     @default(980) @map("currency_code")
  comment       String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([odataId, userId])
  @@index([userId, time])
  @@index([userId, accountId])
  @@map("user_transactions")
}

model UserExcludedTransaction {
  id     String
  odataId String? @map("odata_id") // Original transaction ID from Monobank
  userId String  @map("user_id")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([id, userId])
  @@map("user_excluded_transactions")
}

// Transactions that are manually INCLUDED (override auto-exclusion like internal transfers, ATM withdrawals)
model UserIncludedTransaction {
  id      String
  odataId String? @map("odata_id") // Original transaction ID from Monobank
  userId  String  @map("user_id")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([id, userId])
  @@map("user_included_transactions")
}

model UserDailyBudget {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  date      DateTime // Date for this budget (normalized to start of day)
  limit     Int      // Daily budget limit in kopiykas
  spent     Int      @default(0) // Amount spent on this day in kopiykas
  balance   Int      // Account balance at time of calculation in kopiykas
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
  @@map("user_daily_budgets")
}

// User-defined categories for transaction organization
model UserCategory {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  name      String
  color     String?
  icon      String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactionCategories TransactionCategory[]

  @@index([userId])
  @@map("user_categories")
}

// Category assignments and comments for transactions
model TransactionCategory {
  id            String   @id @default(cuid())
  transactionId String   @map("transaction_id")
  userId        String   @map("user_id")
  categoryId    String?  @map("category_id")
  comment       String?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  category UserCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@unique([transactionId, userId])
  @@index([userId])
  @@index([categoryId])
  @@map("transaction_categories")
}

// Legacy tables for backward compatibility during migration
// These can be removed after full migration

model Setting {
  key   String @id
  value String

  @@map("settings")
}

model Transaction {
  id            String  @id
  time          Int
  description   String
  mcc           Int
  amount        Int
  balance       Int
  cashbackAmount Int     @default(0) @map("cashback_amount")
  comment       String?

  @@index([time])
  @@map("transactions")
}

model ExcludedTransaction {
  id String @id

  @@map("excluded_transactions")
}
